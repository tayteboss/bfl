{{ 'product.css' | asset_url | stylesheet_tag }}

<product-info
  id="MainProduct-{{ section.id }}"
  data-section="{{ section.id }}"
  data-product-id="{{ product.id }}"
  data-update-url="true"
  data-url="{{ product.url }}"
>
  <script src="{{ 'product-info.js' | asset_url }}" defer="defer"></script>
  <script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

  <section id="ProductInfo-{{ section.id }}" class="product-page">
    {%- assign product_form_id = 'product-form-' | append: section.id -%}

    <div class="product-section">
      <div class="layout-wrapper layout-grid">
        <div
          class="product-images-wrapper"
          data-has-foreground-image="{% if product.metafields.custom.foreground_image %}true{% else %}false{% endif %}"
        >
          {% if product.metafields.custom.product_badge %}
            <div class="product-images-wrapper__badge badge-button">
              {{ product.metafields.custom.product_badge | metafield_tag }}
            </div>
          {% endif %}

          {% assign foreground_image = product.metafields.custom.foreground_image %}
          {% assign media_count = product.media.size %}
          {% if foreground_image %}
            {% assign media_count = media_count | plus: 1 %}
          {% endif %}

          {% if media_count > 1 %}
            <div class="swiper product-images-swiper">
              <div class="swiper-wrapper">
                {% if foreground_image %}
                  <div class="swiper-slide product-images-wrapper__slide">
                    <div class="product-images-wrapper__image product-images-wrapper__image--foreground">
                      <img
                        src="{{ foreground_image | image_url }}"
                        alt="{{ product.title }}"
                        class="product-images-wrapper__img"
                        width="auto"
                        height="auto"
                      >
                    </div>
                  </div>
                {% endif %}
                {% for media in product.media %}
                  <div class="swiper-slide product-images-wrapper__slide">
                    <div class="product-images-wrapper__image">
                      <img
                        src="{{ media.src | image_url }}"
                        alt="{{ media.alt | default: product.title }}"
                        class="product-images-wrapper__img"
                        width="auto"
                        height="auto"
                      >
                    </div>
                  </div>
                {% endfor %}
              </div>
              <div class="swiper-pagination"></div>
            </div>
          {% else %}
            {% if foreground_image %}
              <div class="product-images-wrapper__image product-images-wrapper__image--foreground">
                <img
                  src="{{ foreground_image | image_url }}"
                  alt="{{ product.title }}"
                  class="product-images-wrapper__img"
                  width="auto"
                  height="auto"
                >
              </div>
            {% else %}
              {% render 'image', class: 'product-images-wrapper__image', image: product.featured_image %}
            {% endif %}
          {% endif %}
        </div>

        <div class="product-content">
          <div class="product-content__header">
            <h2 class="product-content__vendor type-h1-small">{{ product.vendor }}</h2>
            <h1 class="product-content__title type-h1-small">{{ product.title }}</h1>
          </div>
          <div class="product-content__price">
            <span class="type-p-large">{{ product.price | money }}</span>
          </div>
          <div class="product-content__description-wrapper rich-text type-p">
            {{ product.description }}
          </div>
          {% render 'product-film-features' %}
          <div class="product-form">
            <p class="variant-options__legend type-p">Options:</p>
            {%- assign has_exposure_option = false -%}
            {%- for opt in product.options -%}
              {%- assign opt_down = opt | downcase -%}
              {%- if opt_down == 'exposures' or opt_down == 'exposure' -%}
                {%- assign has_exposure_option = true -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}

            {%- if has_exposure_option -%}
              {%- render 'product-exposure-variants',
                product: product,
                product_form_id: product_form_id,
                section_id: section.id
              -%}
            {%- endif -%}

            {%- assign has_color_option = false -%}
            {%- for opt in product.options -%}
              {%- assign opt_down = opt | downcase -%}
              {%- if opt_down == 'color' -%}
                {%- assign has_color_option = true -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if has_color_option -%}
              {%- render 'product-color-variants',
                product: product,
                product_form_id: product_form_id,
                section_id: section.id
              -%}
            {%- endif -%}

            {%- assign has_size_option = false -%}
            {%- for opt in product.options -%}
              {%- assign opt_down = opt | downcase -%}
              {%- if opt_down == 'size' -%}
                {%- assign has_size_option = true -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if has_size_option -%}
              {%- render 'product-size-variants',
                product: product,
                product_form_id: product_form_id,
                section_id: section.id
              -%}
            {%- endif -%}

            {%- assign has_other_variant_options = false -%}
            {%- for option in product.options_with_values -%}
              {%- assign opt_down = option.name | downcase -%}
              {%- if opt_down != 'exposures'
                and opt_down != 'exposure'
                and opt_down != 'color'
                and opt_down != 'size'
              -%}
                {%- assign has_other_variant_options = true -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if has_other_variant_options -%}
              {%- render 'product-other-variants',
                product: product,
                product_form_id: product_form_id,
                section_id: section.id
              -%}
            {%- endif -%}

            <div class="product-form__bottom">
              <div class="product-form__buy-button" data-hover-shake>
                {%- render 'buy-buttons',
                  product: product,
                  product_form_id: product_form_id,
                  section_id: section.id,
                  show_pickup_availability: true
                -%}
              </div>
              {%- liquid
                assign check_against_inventory = true
                if product.selected_or_first_available_variant.inventory_management != 'shopify' or product.selected_or_first_available_variant.inventory_policy == 'continue'
                  assign check_against_inventory = false
                endif
                if product.selected_or_first_available_variant.quantity_rule.min > product.selected_or_first_available_variant.inventory_quantity and check_against_inventory
                  assign quantity_rule_soldout = true
                endif
                assign is_sold_out = false
                if product.selected_or_first_available_variant.available == false or quantity_rule_soldout or product.selected_or_first_available_variant == null
                  assign is_sold_out = true
                endif
              -%}
              {%- unless is_sold_out -%}
                <div class="quantity-input-wrapper quantity-bubble">
                  <button
                    type="button"
                    class="quantity-btn quantity-btn--minus type-button-large"
                    name="minus"
                    aria-label="Decrease quantity"
                  >
                    -
                  </button>
                  <input
                    id="Quantity-{{ section.id }}"
                    name="quantity"
                    type="number"
                    class="input-selector quantity-input quantity-number type-button-large"
                    form="{{ product_form_id }}"
                    min="{{ product.selected_or_first_available_variant.quantity_rule.min | default: 1 }}"
                    {% if product.selected_or_first_available_variant.quantity_rule.max %}
                      max="{{ product.selected_or_first_available_variant.quantity_rule.max }}"
                    {% endif %}
                    step="{{ product.selected_or_first_available_variant.quantity_rule.increment | default: 1 }}"
                    value="{{ product.selected_or_first_available_variant.quantity_rule.min | default: 1 }}"
                    aria-label="quantity"
                  >
                  <button
                    type="button"
                    class="quantity-btn quantity-btn--plus type-button-large"
                    name="plus"
                    aria-label="Increase quantity"
                  >
                    +
                  </button>
                </div>
              {%- endunless -%}
            </div>
            <div class="product-form__error-message-wrapper" role="alert" hidden>
              <span class="svg-wrapper">
                {{- 'icon-error.svg' | inline_asset_content -}}
              </span>
              <span class="product-form__error-message"></span>
            </div>
          </div>
        </div>
      </div>
      {%- assign show_related = section.settings.show_related | default: true -%}
      {%- if show_related -%}
        {%- assign related_title = section.settings.related_title | default: 'Similar Products' -%}
        {%- assign related_limit = section.settings.related_limit | default: 4 -%}

        {%- assign base_collection = null -%}
        {%- if collection and collection.handle != 'events' -%}
          {%- assign base_collection = collection -%}
        {%- endif -%}
        {%- if base_collection == null -%}
          {%- for coll in product.collections -%}
            {%- if coll.handle != 'events' -%}
              {%- assign base_collection = coll -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {%- if base_collection == null -%}
          {%- assign base_collection = collections.all -%}
        {%- endif -%}

        {%- assign similar_rendered = 0 -%}
        {%- if base_collection and base_collection.products_count > 1 -%}
          <div class="similar-products">
            <div class="layout-wrapper">
              <h2 class="similar-products__title type-h2-medium">{{ related_title }}</h2>
              <div class="similar-products__list layout-grid">
                {%- for item in base_collection.products -%}
                  {%- if item.id != product.id -%}
                    {% render 'product-card', product: item %}
                    {%- assign similar_rendered = similar_rendered | plus: 1 -%}
                    {%- if similar_rendered >= related_limit -%}
                      {%- break -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor -%}
              </div>
            </div>
          </div>
        {%- endif -%}
      {%- endif -%}
    </div>
  </section>

  <script type="application/ld+json">
    {{ product | structured_data }}
  </script>

  <script type="application/json" data-selected-variant>
    {{ product.selected_or_first_available_variant | json }}
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.quantity-input-wrapper').forEach((wrapper) => {
        const input = wrapper.querySelector('.quantity-input');
        const minusBtn = wrapper.querySelector('.quantity-btn--minus');
        const plusBtn = wrapper.querySelector('.quantity-btn--plus');

        const step = parseInt(input.step) || 1;
        const min = parseInt(input.min) || 1;
        const max = parseInt(input.max) || Infinity;

        // Update button disabled states
        function updateButtons() {
          let value = parseInt(input.value) || min;

          minusBtn.disabled = value <= min;
          plusBtn.disabled = value >= max;
        }

        // Initial state
        updateButtons();

        minusBtn.addEventListener('click', () => {
          let value = parseInt(input.value) || min;

          if (value > min) {
            input.value = value - step;
            input.dispatchEvent(new Event('change', { bubbles: true }));
            updateButtons();
          }
        });

        plusBtn.addEventListener('click', () => {
          let value = parseInt(input.value) || min;

          if (value < max) {
            input.value = value + step;
            input.dispatchEvent(new Event('change', { bubbles: true }));
            updateButtons();
          }
        });

        // Also update when user types directly
        input.addEventListener('input', updateButtons);
        input.addEventListener('change', updateButtons);
      });

      // Initialize Swiper for product images
      const productImagesSwiper = document.querySelector('.product-images-swiper');
      if (productImagesSwiper && typeof window.Swiper === 'function') {
        new window.Swiper(productImagesSwiper, {
          slidesPerView: 1,
          spaceBetween: 0,
          loop: false,
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
            type: 'bullets',
          },
        });
      }
    });
  </script>
</product-info>

{% schema %}
{
  "name": "product",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_related",
      "label": "Show related products",
      "default": true
    },
    {
      "type": "text",
      "id": "related_title",
      "label": "Related products heading",
      "default": "Similar Products"
    },
    {
      "type": "range",
      "id": "related_limit",
      "label": "Related products limit",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
