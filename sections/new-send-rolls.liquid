{%- assign target_product = product -%}
{%- if target_product == null and section.settings.carrier_product != blank -%}
  {%- assign target_product = section.settings.carrier_product -%}
{%- endif -%}

{%- if target_product == null -%}
  <p><strong>No product selected.</strong> Choose a “Service product (carrier)” in this section’s settings.</p>
  {% break %}
{%- endif -%}

{%- assign form_data = target_product.metafields.custom.film_services_json.value -%}

<form id="film-service-form" action="{{ routes.cart_add_url }}" method="post">
  <input type="hidden" name="quantity" value="1">
  <input type="hidden" name="id" value="{{ target_product.selected_or_first_available_variant.id }}">

  <!-- BASE PRICE -->
  <div id="base-price" data-base="{{ target_product.price | money_without_currency | default: 0 }}">
    Base: ${{ target_product.price | money_without_currency }}
  </div>

  <!-- LOCATION PICKER -->
  <fieldset data-group="location">
    <legend>Choose a Location</legend>
    <label
      ><input type="radio" name="location" value="Miami" data-price="0" required> Miami (<span class="opt-price"
        >$0</span
      >)</label
    >
    <label
      ><input type="radio" name="location" value="Chicago" data-price="2"> Chicago (<span class="opt-price">$2</span
      >)</label
    >
    <label
      ><input type="radio" name="location" value="Orlando" data-price="0"> Orlando (<span class="opt-price">$0</span
      >)</label
    >
    <label
      ><input type="radio" name="location" value="Atlanta" data-price="0"> Atlanta (<span class="opt-price">$0</span
      >)</label
    >
  </fieldset>

  <!-- SERVICE PICKER -->
  <fieldset data-group="Service">
    <legend>Choose a Service</legend>
    {% for service_name in form_data %}
      {% assign service_key = service_name[0] %}
      {% assign service_object = service_name[1] %}
      {% assign show_if = service_object.show_if | default: '{}' | json | escape %}

      <label>
        <input
          type="radio"
          name="service"
          value="{{ service_key | escape }}"
          data-price="0"
          data-show-if="{{ show_if }}"
          required
        >
        {{ service_key }} (<span class="opt-price">$0</span>)
      </label>
    {% endfor %}
  </fieldset>

  <!-- SERVICE GROUPS -->
  {% for service in form_data %}
    {% assign service_name = service[0] %}
    {% assign groups = service[1] %}
    <div class="service-groups-block" data-for-service="{{ service_name | escape }}">
      {% for group in groups %}
        {% assign group_name = group[0] %}
        {% assign group_data = group[1] %}
        {% assign accordion_title = group_data.accordion_title %}
        {% assign accordion_sub_title = group_data.accordion_sub_title %}
        {% assign options = group_data.options | default: group_data %}

        <fieldset data-group="{{ group_name | escape }}">
          <legend>{{ group_name }}</legend>

          {% for opt in options %}
            <label>
              <input
                type="radio"
                name="{{ group_name | handle }}"
                value="{{ opt.label | escape }}"
                data-price="{{ opt.price | default: 0 }}"
                data-show-if="{{ opt.show_if | json | escape }}"
                data-price-overrides="{{ opt.price_overrides | json | escape }}"
              >
              {{ opt.label }} (<span class="opt-price">${{ opt.price | default: 0 }}</span>)
            </label>
          {% endfor %}

          {% if accordion_title or accordion_sub_title %}
            <details class="accordion-send-rolls">
              <summary>{{ accordion_title | default: group_name }}</summary>
              {% if accordion_sub_title %}
                <p class="accordion-subtitle">{{ accordion_sub_title }}</p>
              {% endif %}

              {% for opt in options %}
                {% if opt.description or opt.description_image %}
                  <div class="accordion-option">
                    {% if opt.description_image %}
                      <img
                        {% comment %} src="{{ opt.description_image | image_url }}" {% endcomment %}
                        src="https://cdn.shopify.com/s/files/1/0776/3129/1647/files/placeholder-product-foreground.png?v=1761916752"
                        alt=""
                        class="desc-image"
                        width="50px"
                        height="50px"
                      >
                    {% endif %}
                    <div class="accordion-inner-send-rolls">
                      <strong>{{ opt.label }}</strong>
                      {% if opt.description %}
                        <p>{{ opt.description }}</p>
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              {% endfor %}
            </details>
          {% endif %}
        </fieldset>
      {% endfor %}
    </div>
  {% endfor %}

  <div class="end-form">
    <button type="submit">Submit Form</button>
    <div id="film-total-display" style="margin:auto; font-weight:bold;">Total: $0.00</div>
  </div>
</form>

<!-- VARIANT DATA -->
<script>
  window.productVariants = {{ target_product.variants | json }};
</script>

<script src="{{ 'film-service.js' | asset_url }}" defer="defer"></script>

{% style %}
  fieldset {
    margin-bottom: 20px;
    border: 1px solid black;
    padding: 1rem;
    border-radius: 6px;
  }

  legend {
    margin: auto;
    font-weight: 600;
  }

  label {
    margin-bottom: 0.25rem;
  }

  input {
    appearance: auto;
  }

  .opt-price {
    font-weight: 600;
  }

  .end-form {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }

  .desc-image {
    width: 50px;
    height: 50px;
  }

  .accordion-option {
    display: flex;
  }
{% endstyle %}

{% schema %} { "name": "Send Rolls (Dynamic)", "settings": [ { "type": "product", "id": "carrier_product", "label": "Service product (carrier)" } ], "presets": [ { "name": "Send Rolls (Dynamic)" } ] } {% endschema %}
