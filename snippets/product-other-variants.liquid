{%- assign has_other_options = false -%}
{%- for option in product.options_with_values -%}
  {%- assign opt_normalized = option.name | downcase | strip -%}
  {%- assign opt_tokens = opt_normalized | split: ' ' -%}
  {%- assign opt_first = opt_tokens[0] -%}
  {%- if opt_first == 'exposures'
    or opt_first == 'exposure'
    or opt_first == 'color'
    or opt_first == 'colors'
    or opt_first == 'size'
    or opt_first == 'sizes'
  -%}
    {%- continue -%}
  {%- endif -%}
  {%- if option.values.size > 1 -%}
    {%- assign has_other_options = true -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- if has_other_options -%}
  <div class="other-variant-options" data-section-id="{{ section_id }}">
    {%- for option in product.options_with_values -%}
      {%- assign opt_normalized = option.name | downcase | strip -%}
      {%- assign opt_tokens = opt_normalized | split: ' ' -%}
      {%- assign opt_first = opt_tokens[0] -%}
      {%- if opt_first == 'exposures'
        or opt_first == 'exposure'
        or opt_first == 'color'
        or opt_first == 'colors'
        or opt_first == 'size'
        or opt_first == 'sizes'
        or option.values.size <= 1
      -%}
        {%- continue -%}
      {%- endif -%}
      <div class="product-form__input">
        {% comment %} <label class="form__label" for="Option-{{ section_id }}-{{ forloop.index0 }}">{{ option.name }}</label> {% endcomment %}
        <div class="select-wrapper">
          <select
            id="Option-{{ section_id }}-{{ forloop.index0 }}"
            class="select__select"
            name="options[{{ option.name | escape }}]"
            form="{{ product_form_id }}"
            aria-label="{{ option.name }}"
          >
            <option
              value=""
              disabled
              {% if option.selected_value == blank %}
                selected
              {% endif -%}
              hidden
            >
              {{ option.name }}
            </option>
            {%- for value in option.values -%}
              <option
                value="{{ value | escape }}"
                {% if value == option.selected_value %}
                  selected
                {% endif %}
              >
                {{ value }}
              </option>
            {%- endfor -%}
          </select>
          <span class="select-caret" aria-hidden="true">â–¼</span>
        </div>
      </div>
    {%- endfor -%}
  </div>

  {%- comment -%}
    Always include variants JSON - it's needed for variant matching.
    The exposure snippet also includes it with the same ID, but having it here
    ensures it's available even if exposure snippet doesn't render first.
  {%- endcomment -%}
  <script type="application/json" id="ProductVariants-{{ section_id }}">
    {{ product.variants | json }}
  </script>

  <script>
    (function() {
      function init() {
      const root = document.getElementById('MainProduct-{{ section_id }}');
      if (!root) return;
      
      const form = document.getElementById('{{ product_form_id }}');
      if (!form) return;
      
      const idInput = form.querySelector('input[name="id"]');
      if (!idInput) return;
      
      let variants = [];
      const variantsEl = document.getElementById('ProductVariants-{{ section_id }}');
      if (variantsEl) {
        try { 
          variants = JSON.parse(variantsEl.textContent || '[]'); 
        } catch (e) {}
      }
      
      if (variants.length === 0) {
        const structuredDataScript = root.querySelector('script[type="application/ld+json"]');
        if (structuredDataScript) {
          try {
            const structuredData = JSON.parse(structuredDataScript.textContent);
            if (structuredData.offers && Array.isArray(structuredData.offers)) {
              // This won't give us full variant data, but it's a fallback
            }
          } catch (e) {}
        }
        
        if (window.productData && window.productData.variants) {
          variants = window.productData.variants;
        }
      }

      const optionNames = {{ product.options | json }};

      function getSelectedForName(name, index) {
        const nameLower = name.toLowerCase();
        // Use exposure radio if present
        if (nameLower === 'exposures' || nameLower === 'exposure') {
          const exp = root.querySelector('input[name="exposure-choice"]:checked');
          return exp ? exp.value : null;
        }
        // Use color radio if present
        if (nameLower === 'color' || nameLower === 'colors') {
          const color = root.querySelector('input[name="color-choice"]:checked');
          return color ? color.value : null;
        }
        // Use size radio if present
        if (nameLower === 'size' || nameLower === 'sizes') {
          const size = root.querySelector('input[name="size-choice"]:checked');
          return size ? size.value : null;
        }
        // Otherwise look for our select
        const sel = root.querySelector(`select[name="options[${CSS.escape(name)}]"]`);
        if (sel) return sel.value === '' ? null : sel.value;
        return null;
      }

      function findVariantByOptions(selected) {
        if (!Array.isArray(selected) || selected.includes(null)) return null;
        return variants.find((v) => Array.isArray(v.options) && v.options.every((opt, i) => opt === selected[i])) || null;
      }

      function handleVariantChange(event) {
        const selected = optionNames.map((name, idx) => getSelectedForName(name, idx));
        const matched = findVariantByOptions(selected);
        if (!matched) return;
        
        const idInputs = form.querySelectorAll('input[name="id"]');
        idInputs.forEach((input) => {
          input.value = matched.id;
          input.toggleAttribute('disabled', !matched.available);
          input.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }


      root.querySelectorAll('.other-variant-options select').forEach((sel) => {
        sel.addEventListener('change', handleVariantChange);
      });
      
      root.querySelectorAll('input[name="exposure-choice"], input[name="color-choice"], input[name="size-choice"]').forEach((radio) => {
        radio.addEventListener('change', handleVariantChange);
      });

      form.addEventListener('submit', (e) => {
        const selected = optionNames.map((name, idx) => getSelectedForName(name, idx));
        const matched = findVariantByOptions(selected);
        
        if (matched) {
          const finalIdInputs = form.querySelectorAll('input[name="id"]');
          finalIdInputs.forEach((input) => {
            if (input.value !== matched.id) {
              input.value = matched.id;
              input.toggleAttribute('disabled', !matched.available);
              input.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        }
      }, { capture: true });

      handleVariantChange();
      }
      
      // Run immediately or wait for DOM
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        // DOM already ready, but wait a tick to ensure everything is loaded
        setTimeout(init, 0);
      }
    })();
  </script>
{%- endif -%}
