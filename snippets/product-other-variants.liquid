{%- assign has_other_options = false -%}
{%- for option in product.options_with_values -%}
  {%- assign opt_normalized = option.name | downcase | strip -%}
  {%- assign opt_tokens = opt_normalized | split: ' ' -%}
  {%- assign opt_first = opt_tokens[0] -%}
  {%- if opt_first == 'exposures'
    or opt_first == 'exposure'
    or opt_first == 'color'
    or opt_first == 'colors'
    or opt_first == 'size'
    or opt_first == 'sizes'
  -%}
    {%- continue -%}
  {%- endif -%}
  {%- if option.values.size > 1 -%}
    {%- assign has_other_options = true -%}
    {%- break -%}
  {%- endif -%}
{%- endfor -%}

{%- if has_other_options -%}
  <div class="other-variant-options" data-section-id="{{ section_id }}">
    {%- for option in product.options_with_values -%}
      {%- assign opt_normalized = option.name | downcase | strip -%}
      {%- assign opt_tokens = opt_normalized | split: ' ' -%}
      {%- assign opt_first = opt_tokens[0] -%}
      {%- if opt_first == 'exposures'
        or opt_first == 'exposure'
        or opt_first == 'color'
        or opt_first == 'colors'
        or opt_first == 'size'
        or opt_first == 'sizes'
        or option.values.size <= 1
      -%}
        {%- continue -%}
      {%- endif -%}
      <div class="product-form__input">
        {% comment %} <label class="form__label" for="Option-{{ section_id }}-{{ forloop.index0 }}">{{ option.name }}</label> {% endcomment %}
        <div class="select-wrapper">
          <select
            id="Option-{{ section_id }}-{{ forloop.index0 }}"
            class="select__select"
            name="options[{{ option.name | escape }}]"
            form="{{ product_form_id }}"
            aria-label="{{ option.name }}"
          >
            <option
              value=""
              disabled
              {% if option.selected_value == blank %}
                selected
              {% endif -%}
              hidden
            >
              {{ option.name }}
            </option>
            {%- for value in option.values -%}
              <option
                value="{{ value | escape }}"
                {% if value == option.selected_value %}
                  selected
                {% endif %}
              >
                {{ value }}
              </option>
            {%- endfor -%}
          </select>
          <span class="select-caret" aria-hidden="true">â–¼</span>
        </div>
      </div>
    {%- endfor -%}
  </div>

  {%- assign has_exposure = false -%}
  {%- for opt in product.options -%}
    {%- assign opt_normalized = opt | downcase | strip -%}
    {%- assign opt_tokens = opt_normalized | split: ' ' -%}
    {%- assign opt_first = opt_tokens[0] -%}
    {%- if opt_first == 'exposures' or opt_first == 'exposure' -%}
      {%- assign has_exposure = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
  {%- unless has_exposure -%}
    <script type="application/json" id="ProductVariants-{{ section_id }}">
      {{ product.variants | json }}
    </script>
  {%- endunless -%}

  <script>
    (function() {
      const root = document.getElementById('MainProduct-{{ section_id }}');
      if (!root) return;
      const form = document.getElementById('{{ product_form_id }}');
      if (!form) return;
      const idInput = form.querySelector('input[name="id"]');
      if (!idInput) return;
      const variantsEl = document.getElementById('ProductVariants-{{ section_id }}');
      let variants = [];
      try { variants = JSON.parse(variantsEl?.textContent || '[]'); } catch (e) {}

      const optionNames = {{ product.options | json }};

      function getSelectedForName(name, index) {
        // Use exposure radio if present
        if (name === 'Exposures') {
          const exp = root.querySelector('input[name="exposure-choice"]:checked');
          return exp ? exp.value : null;
        }
        // Otherwise look for our select
        const sel = root.querySelector(`select[name="options[${CSS.escape(name)}]"]`);
        if (sel) return sel.value === '' ? null : sel.value;
        return null;
      }

      function findVariantByOptions(selected) {
        if (!Array.isArray(selected) || selected.includes(null)) return null;
        return variants.find((v) => Array.isArray(v.options) && v.options.every((opt, i) => opt === selected[i])) || null;
      }

      function handleVariantChange() {
        const selected = optionNames.map((name, idx) => getSelectedForName(name, idx));
        const matched = findVariantByOptions(selected);
        if (!matched) return;
        idInput.value = matched.id;
        idInput.toggleAttribute('disabled', !matched.available);
        idInput.dispatchEvent(new Event('change', { bubbles: true }));
      }

      // Bind to our selects
      root.querySelectorAll('.other-variant-options select').forEach((sel) => sel.addEventListener('change', handleVariantChange));
      // Also react to exposure changes if present
      root.querySelectorAll('input[name="exposure-choice"]').forEach((radio) => radio.addEventListener('change', handleVariantChange));

      // Initialize
      handleVariantChange();
    })();
  </script>
{%- endif -%}
