{%- assign color_option_index = null -%}
{%- assign selected_color_value = null -%}
{%- for option in product.options_with_values -%}
  {%- assign opt_normalized = option.name | downcase | strip -%}
  {%- assign opt_tokens = opt_normalized | split: ' ' -%}
  {%- assign opt_first = opt_tokens[0] -%}
  {%- if opt_first == 'color' or opt_first == 'colors' -%}
    {%- assign color_option_index = forloop.index0 -%}
  {%- endif -%}
{%- endfor -%}

{%- if color_option_index != null -%}
  {%- if color_option_index == 0 -%}
    {%- assign selected_color_value = product.selected_or_first_available_variant.option1 -%}
  {%- elsif color_option_index == 1 -%}
    {%- assign selected_color_value = product.selected_or_first_available_variant.option2 -%}
  {%- else -%}
    {%- assign selected_color_value = product.selected_or_first_available_variant.option3 -%}
  {%- endif -%}

  <div
    class="variant-selector"
    data-variant-index="{{ color_option_index }}"
    data-form-id="{{ product_form_id }}"
    data-section-id="{{ section_id }}"
  >
    <fieldset class="variant-options">
      <div class="variant-selector__options">
        {%- for option in product.options_with_values -%}
          {%- assign opt_normalized = option.name | downcase | strip -%}
          {%- assign opt_tokens = opt_normalized | split: ' ' -%}
          {%- assign opt_first = opt_tokens[0] -%}
          {%- if opt_first == 'color' or opt_first == 'colors' -%}
            {%- for value in option.values -%}
              {%- assign available_for_value = false -%}
              {%- for v in product.variants -%}
                {%- if color_option_index == 0 and v.option1 == value and v.available -%}
                  {%- assign available_for_value = true -%}
                  {%- break -%}
                {%- elsif color_option_index == 1 and v.option2 == value and v.available -%}
                  {%- assign available_for_value = true -%}
                  {%- break -%}
                {%- elsif color_option_index == 2 and v.option3 == value and v.available -%}
                  {%- assign available_for_value = true -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}
              {%- liquid
                assign color_style = ''
                assign color_image = ''
                if value.swatch.color
                  assign r = value.swatch.color.r
                  assign g = value.swatch.color.g
                  assign b = value.swatch.color.b
                  assign color_style = 'rgb(' | append: r | append: ', ' | append: g | append: ', ' | append: b | append: ')'
                elsif value.swatch.image
                  assign image_url = value.swatch.image | image_url: width: 50
                  assign color_image = image_url
                else
                  assign color_value_lower = value | downcase
                  assign color_map = 'red:#FF0000,blue:#0000FF,green:#008000,yellow:#FFFF00,orange:#FFA500,purple:#800080,pink:#FFC0CB,black:#000000,white:#FFFFFF,gray:#808080,grey:#808080,brown:#A52A2A,navy:#000080,teal:#008080,beige:#F5F5DC,tan:#D2B48C,maroon:#800000,olive:#808000,lime:#00FF00,aqua:#00FFFF,cyan:#00FFFF,silver:#C0C0C0,gold:#FFD700'
                  assign color_parts = color_map | split: ','
                  for color_part in color_parts
                    assign color_pair = color_part | split: ':'
                    if color_pair[0] == color_value_lower
                      assign color_style = color_pair[1]
                      break
                    endif
                  endfor
                  if color_style == ''
                    assign color_style = '#000000'
                  endif
                endif
              -%}
              <label
                for="Color-{{ section_id }}-{{ value | handle }}"
                class="variant-selector__option{% if value == selected_color_value %} is-active{% endif %}{% unless available_for_value %} is-unavailable{% endunless %}"
              >
                <div class="product-film-features__hint-value product-film-features__hint-value--bottom">Sold Out</div>
                <input
                  type="radio"
                  id="Color-{{ section_id }}-{{ value | handle }}"
                  name="color-choice"
                  value="{{ value | escape }}"
                  {% if value == selected_color_value %}
                    checked
                  {% endif %}
                  {% unless available_for_value %}
                    disabled
                  {% endunless %}
                >
                <div
                  class="variant-selector__color-circle"
                  style="background-color: {{ color_style }}{% if color_image != '' %}; background-image: url({{ color_image }}); background-size: cover;{% endif %}"
                ></div>
                <div class="variant-selector__option-icon">COLOR</div>
              </label>
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}
      </div>
    </fieldset>
  </div>

  {%- assign has_exposure_option = false -%}
  {%- for opt in product.options -%}
    {%- assign opt_normalized = opt | downcase | strip -%}
    {%- assign opt_tokens = opt_normalized | split: ' ' -%}
    {%- assign opt_first = opt_tokens[0] -%}
    {%- if opt_first == 'exposures' or opt_first == 'exposure' -%}
      {%- assign has_exposure_option = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
  {%- unless has_exposure_option -%}
    <script type="application/json" id="ProductVariants-{{ section_id }}">
      {{ product.variants | json }}
    </script>
  {%- endunless -%}

  <script>
    (function () {
      function init() {
        const root = document.getElementById('MainProduct-{{ section_id }}');
        if (!root) return;
        // Find the specific variant selector for colors by looking for the color-choice input
        const colorInput = root.querySelector('input[name="color-choice"]');
        const wrap = colorInput ? colorInput.closest('.variant-selector') : null;
        if (!wrap) return;
        const form = document.getElementById('{{ product_form_id }}');
        if (!form) return;
        const idInput = form.querySelector('input[name="id"]');
        if (!idInput) return;
        const variantsEl = document.getElementById('ProductVariants-{{ section_id }}');
        let variants = [];
        try {
          variants = JSON.parse(variantsEl?.textContent || '[]');
        } catch (e) {}
        const colorIndex = parseInt(wrap.getAttribute('data-variant-index') || '0', 10);
        const optionNames = {{ product.options | json }};

        function getSelectedOptions() {
          return optionNames.map((_, idx) => {
            if (idx === colorIndex) {
              const r = wrap.querySelector('input[name="color-choice"]:checked');
              return r ? r.value : null;
            }
            // Check for other variant selectors (exposure, size)
            const exposureRadio = root.querySelector('input[name="exposure-choice"]:checked');
            if (exposureRadio) {
              const exposureWrap = root.querySelector('.variant-selector input[name="exposure-choice"]');
              if (exposureWrap) {
                const exposureWrapParent = exposureWrap.closest('.variant-selector');
                const exposureIndex = parseInt(exposureWrapParent?.getAttribute('data-variant-index') || '-1', 10);
                if (idx === exposureIndex) {
                  return exposureRadio.value;
                }
              }
            }
            const sizeRadio = root.querySelector('input[name="size-choice"]:checked');
            if (sizeRadio) {
              const sizeWrap = root.querySelector('.variant-selector input[name="size-choice"]');
              if (sizeWrap) {
                const sizeWrapParent = sizeWrap.closest('.variant-selector');
                const sizeIndex = parseInt(sizeWrapParent?.getAttribute('data-variant-index') || '-1', 10);
                if (idx === sizeIndex) {
                  return sizeRadio.value;
                }
              }
            }
            const sel = root.querySelector(`#Option-{{ section_id }}-${idx}`);
            return sel ? sel.value : null;
          });
        }

        function findVariantByOptions(selected) {
          if (!Array.isArray(selected) || selected.includes(null)) return null;
          
          // First try to find an available variant that matches all options
          const availableVariant = variants.find((v) => 
            v.available && 
            Array.isArray(v.options) && 
            v.options.every((opt, i) => opt === selected[i])
          );
          
          if (availableVariant) {
            return availableVariant;
          }
          
          // If no available variant, find any matching variant (for display purposes)
          const anyVariant = variants.find((v) => 
            Array.isArray(v.options) && 
            v.options.every((opt, i) => opt === selected[i])
          );
          
          return anyVariant || null;
        }

        function formatCents(cents) {
          const value = (cents || 0) / 100;
          try {
            return new Intl.NumberFormat(undefined, {
              style: 'currency',
              currency: '{{ cart.currency.iso_code }}',
              currencyDisplay: 'symbol',
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            }).format(value);
          } catch (e) {
            return `${'{{ cart.currency.symbol }}'}${value.toFixed(2)}`;
          }
        }

        function updateActiveState() {
          wrap.querySelectorAll('.variant-selector__option').forEach((opt) => opt.classList.remove('is-active'));
          const checked = wrap.querySelector('input[name="color-choice"]:checked');
          if (checked) checked.closest('.variant-selector__option')?.classList.add('is-active');
        }
        
        function updateAvailabilityState() {
          // Update availability state for all color options based on current variants
          wrap.querySelectorAll('.variant-selector__option').forEach((optionEl) => {
            const radio = optionEl.querySelector('input[type="radio"]');
            if (!radio) return;
            
            const colorValue = radio.value;
            
            // Check if there's any available variant with this color
            const hasAvailableVariant = variants.some((v) => {
              if (!v.available) return false;
              if (!Array.isArray(v.options)) return false;
              return v.options[colorIndex] === colorValue;
            });
            
            if (hasAvailableVariant) {
              optionEl.classList.remove('is-unavailable');
              radio.disabled = false;
            } else {
              optionEl.classList.add('is-unavailable');
              radio.disabled = true;
              // If this option is checked but unavailable, uncheck it
              if (radio.checked) {
                radio.checked = false;
                // Find and select the first available option
                const firstAvailable = wrap.querySelector('.variant-selector__option:not(.is-unavailable) input[type="radio"]');
                if (firstAvailable) {
                  firstAvailable.checked = true;
                  firstAvailable.dispatchEvent(new Event('change', { bubbles: true }));
                }
              }
            }
          });
        }

        function handleVariantChange() {
          updateActiveState();
          const selected = getSelectedOptions();
          
          const matched = findVariantByOptions(selected);
          
          // If no match OR if matched variant is unavailable, try to find an available variant
          if (!matched || !matched.available) {
            const colorValue = selected[colorIndex];
            if (colorValue) {
              // Find any available variant with the selected color
              const availableWithColor = variants.find((v) => {
                if (!v.available) return false;
                if (!Array.isArray(v.options)) return false;
                return v.options[colorIndex] === colorValue;
              });
              
              if (availableWithColor) {
                // Update other option selects to match this available variant
                let optionsUpdated = false;
                optionNames.forEach((name, idx) => {
                  if (idx !== colorIndex && availableWithColor.options[idx]) {
                    const sel = root.querySelector(`#Option-{{ section_id }}-${idx}`);
                    if (sel && sel.value !== availableWithColor.options[idx]) {
                      sel.value = availableWithColor.options[idx];
                      optionsUpdated = true;
                    }
                  }
                });
                
                // If we updated options, retry matching
                if (optionsUpdated) {
                  const updatedSelected = getSelectedOptions();
                  const retryMatched = findVariantByOptions(updatedSelected);
                  if (retryMatched && retryMatched.available) {
                    updateVariantUI(retryMatched);
                    return;
                  }
                } else {
                  // Options didn't need updating, use the available variant directly
                  updateVariantUI(availableWithColor);
                  return;
                }
              } else {
                // Still no available variant - disable button
                if (matched && !matched.available) {
                  updateVariantUI(matched); // Still update UI to show it's unavailable
                  return;
                }
              }
            }
            
            // No match at all - disable button
            if (!matched) {
              const submit = document.getElementById('ProductSubmitButton-{{ section_id }}');
              if (submit) {
                submit.setAttribute('disabled', 'disabled');
                submit.setAttribute('aria-disabled', 'true');
              }
              return;
            }
          }
          
          // Matched variant is available - use it
          updateVariantUI(matched);
        }
        
        function updateVariantUI(matched) {
          // Update variant ID input
          idInput.value = matched.id;
          // Never disable the input - just disable the button if unavailable
          idInput.removeAttribute('disabled');
          idInput.dispatchEvent(new Event('change', { bubbles: true }));

          // Update price in-place (fallback)
          const priceNodes = root.querySelectorAll('.product-content__price .type-p-large');
          const priceEl = priceNodes && priceNodes[priceNodes.length - 1];
          if (priceEl) priceEl.textContent = formatCents(matched.price);

          // Toggle submit button disabled state for UX
          const submit = document.getElementById('ProductSubmitButton-{{ section_id }}');
          if (submit) {
            if (matched.available) {
              submit.removeAttribute('disabled');
              submit.removeAttribute('aria-disabled');
            } else {
              submit.setAttribute('disabled', 'disabled');
              submit.setAttribute('aria-disabled', 'true');
            }
          }
          
          // Ensure form is properly initialized after variant change
          // Check if product-form element exists and re-initialize if needed
          const productForm = form.closest('product-form');
          if (productForm && typeof productForm.initialize === 'function') {
            // Just verify form is still initialized, don't re-init unnecessarily
            if (!productForm._initialized) {
              productForm.initialize();
            }
          }
        }

        // Click the entire option to select
        wrap.querySelectorAll('.variant-selector__option').forEach((opt) => {
          opt.addEventListener('click', (e) => {
            const input = opt.querySelector('input[type="radio"]');
            if (!input || input.disabled) return;
            if (!input.checked) {
              input.checked = true;
              input.dispatchEvent(new Event('change', { bubbles: true }));
            }
          });
        });

        // Bind to radio changes
        wrap.querySelectorAll('input[type="radio"][name="color-choice"]').forEach((radio) => {
          radio.addEventListener('change', handleVariantChange);
        });

        // Also react to changes on other option selects
        root.querySelectorAll('select[id^="Option-{{ section_id }}-"]').forEach((sel) => {
          sel.addEventListener('change', () => {
            updateAvailabilityState();
            handleVariantChange();
          });
        });

        // React to changes in other variant selectors (exposure, size)
        root.querySelectorAll('input[name="exposure-choice"], input[name="size-choice"]').forEach((radio) => {
          radio.addEventListener('change', () => {
            updateAvailabilityState();
            handleVariantChange();
          });
        });

        // Initialize
        updateAvailabilityState();
        handleVariantChange();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init, { once: true });
      } else {
        init();
      }
    })();
  </script>
{%- endif -%}
