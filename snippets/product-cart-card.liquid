{%- comment -%}
  Reusable cart product card for cart drawer and cart page
  Usage: {% render 'product-cart-card', item: item, index: item.index | plus: 1 %}
{%- endcomment -%}

{%- assign index = index | default: item.index | plus: 1 -%}

<div
  id="{% if context == 'page' %}CartItem-{{ index }}{% else %}CartDrawer-Item-{{ index }}{% endif %}"
  class="cart-item cart-card"
>
  <div class="cart-card__inner">
    <div class="cart-item__media">
      {% assign bg_image = item.product.metafields.custom.background_image %}
      {% assign first_media = item.product.media | first %}
      {% if item.image and item.product.title != 'Tape Digitization' and bg_image == blank %}
        <a href="{{ item.url }}" class="cart-item__link" tabindex="-1" aria-hidden="true"> </a>
        <img
          class="cart-item__image"
          src="{{ item.image | image_url: width: 300 }}"
          alt="{{ item.image.alt | escape }}"
          loading="lazy"
          width="150"
          height="{{ 150 | divided_by: item.image.aspect_ratio | ceil }}"
          style="object-fit: cover; width: 100%; height: 100%;"
        >
      {% elsif item.product.title == 'Tape Digitization' and bg_image != blank %}
        <img
          class="cart-item__image cart-item__image--background"
          src="{{ bg_image | image_url: width: 300 }}"
          alt="{{ item.product.title | escape }}"
          loading="lazy"
          width="160"
          height="160"
          style="object-fit: cover; width: 100%; height: 100%;"
        >
      {% elsif bg_image != blank and first_media != blank %}
        <img
          class="cart-item__image cart-item__image--foreground"
          src="{{ first_media.src | image_url: width: 300 }}"
          alt="{{ item.product.title | escape }}"
          loading="lazy"
          width="160"
          height="160"
          style="object-fit: contain;"
        >
      {% elsif first_media != blank %}
        <img
          class="cart-item__image"
          src="{{ first_media.src | image_url: width: 300 }}"
          alt="{{ item.product.title | escape }}"
          loading="lazy"
          width="150"
          height="150"
          style="object-fit: cover; width: 100%; height: 100%;"
        >
      {% endif %}
    </div>

    <div class="cart-card__content">
      {%- if item.product.vendor -%}
        <p class="type-h4 cart-item__vendor">
          {{ item.product.vendor }}
        </p>
      {%- endif -%}
      <a href="{{ item.url }}" class="cart-item__name type-p">
        {{- item.product.title | escape -}}
      </a>

      <div class="cart-item__price-wrapper">
        {%- if item.quantity > 1 -%}
          <span class="cart-item__quantity-note type-p-small"> Qty: {{ item.quantity }} - </span>
        {%- endif -%}
        {%- if item.variant.available and item.unit_price_measurement -%}
          <div class="unit-price caption">
            <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
            {{ item.unit_price | money }}
            <span aria-hidden="true">/</span>
            <span class="visually-hidden">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span>
            {%- if item.unit_price_measurement.reference_value != 1 -%}
              {{- item.unit_price_measurement.reference_value -}}
            {%- endif -%}
            {{ item.unit_price_measurement.reference_unit }}
          </div>
        {%- endif -%}
        {%- if item.original_line_price != item.final_line_price -%}
          <div class="cart-item__discounted-prices type-p-small">
            <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
            <s class="cart-item__old-price price price--end type-p-small">{{ item.original_line_price | money }}</s>
            <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
            <span class="price price--end type-p-small">{{ item.final_line_price | money }}</span>
          </div>
        {%- else -%}
          <span class="price price--end type-p-small">{{ item.original_line_price | money }}</span>
        {%- endif -%}
      </div>

      {% comment %}
        <cart-remove-button
          class="cart-remove-button type-p-small"
          id="CartDrawer-Remove-{{ index }}"
          data-index="{{ index }}"
        >
          <button
            type="button"
            class="button button--tertiary cart-remove-button type-p-small"
            aria-label="{{ 'sections.cart.remove_title' | t: title: item.title | escape }}"
            data-variant-id="{{ item.variant.id }}"
          >
            Remove
          </button>
        </cart-remove-button>
      {% endcomment %}

      {% comment %}
        {%- if item.original_price != item.final_price -%}
          <div class="cart-item__discounted-prices">
            <span class="visually-hidden">{{ 'products.product.price.regular_price' | t }}</span>
            <s class="cart-item__old-price product-option">{{- item.original_price | money -}}</s>
            <span class="visually-hidden">{{ 'products.product.price.sale_price' | t }}</span>
            <strong class="cart-item__final-price product-option">{{ item.final_price | money }}</strong>
          </div>
        {%- else -%}
          <div class="product-option">{{ item.original_price | money }}</div>
        {%- endif -%}
      {% endcomment %}

      {%- if item.product.has_only_default_variant == false
        or item.properties.size != 0
        or item.selling_plan_allocation != null
      -%}
        <dl style="margin-bottom: 16px;">
          {%- if item.product.has_only_default_variant == false -%}
            {%- for option in item.options_with_values -%}
              {%- unless option.name == 'Step' or option.name == 'Total Price' -%}
                <div class="product-option">
                  <dt class="type-p-small">{{ option.name }}:</dt>
                  <dd class="type-p-small">
                    {{ option.value -}}
                    {%- unless forloop.last %}, {% endunless %}
                  </dd>
                </div>
              {%- endunless -%}
            {%- endfor -%}
          {%- endif -%}

          {%- for property in item.properties -%}
            {%- assign property_first_char = property.first | slice: 0 -%}
            {%- if property.last != blank
              and property_first_char != '_'
              and property.first != 'Total Price'
              and property.first != 'Delivery Address'
              and property.first != 'Upload your prints here!'
            -%}
              <div class="product-option type-p-small">
                <dt class="type-p-small">{{ property.first }}:</dt>
                <dd class="type-p-small">
                  {%- if property.last contains '/uploads/' -%}
                    <a
                      href="{{ property.last }}"
                      class="link"
                      target="_blank"
                      aria-describedby="a11y-new-window-message"
                    >
                      {{- property.last | split: '/' | last -}}
                    </a>
                  {%- else -%}
                    {{ property.last }}
                  {%- endif -%}
                </dd>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </dl>

        <p class="product-option type-p-small">{{ item.selling_plan_allocation.selling_plan.name }}</p>
      {%- endif -%}

      {%- unless item.properties._role == 'return_shipping' -%}
        <cart-remove-button
          class="cart-remove-button type-p-small"
          data-key="{{ item.key }}"
        >
          <button
            type="button"
            class="button button--tertiary cart-remove-button type-p-small"
            aria-label="{{ 'sections.cart.remove_title' | t: title: item.title | escape }}"
          >
            remove
          </button>
        </cart-remove-button>
      {%- endunless -%}

      <ul class="discounts list-unstyled" role="list" aria-label="{{ 'customer.order.discount' | t }}">
        {%- for discount in item.line_level_discount_allocations -%}
          <li class="discounts__discount">
            {{- 'icon-discount.svg' | inline_asset_content -}}
            {{ discount.discount_application.title }}
          </li>
        {%- endfor -%}
      </ul>

      {%- liquid
        assign has_qty_rules = false
        if item.variant.quantity_rule.increment > 1 or item.variant.quantity_rule.min > 1 or item.variant.quantity_rule.max != null
          assign has_qty_rules = true
        endif

        assign has_vol_pricing = false
        if item.variant.quantity_price_breaks.size > 0
          assign has_vol_pricing = true
        endif
      -%}

      <div class="cart-card__footer">
        {%- render 'loading-spinner' -%}

        <div class="cart-item__quantity {% if has_qty_rules or has_vol_pricing %} cart-item__quantity--info{% endif %}">
          <quantity-popover>
            <div class="cart-item__quantity-wrapper quantity-popover-wrapper">
              <div class="quantity-popover-container{% if has_qty_rules or has_vol_pricing %} quantity-popover-container--hover{% endif %}">
                <label class="visually-hidden" for="Quantity-{{ index }}">
                  {{- 'products.product.quantity.label' | t -}}
                </label>
                <quantity-input
                  class="quantity cart-quantity"
                  {% if item.properties._role == 'return_shipping' %}
                    style="pointer-events:none;"
                  {% endif %}
                >
                  {%- unless item.properties._role == 'return_shipping' -%}
                    <button class="quantity__button" name="minus" type="button">
                      <span class="visually-hidden">
                        {{- 'products.product.quantity.decrease' | t: product: item.product.title | escape -}}
                      </span>
                      <span class="svg-wrapper"> - </span>
                    </button>
                  {%- endunless -%}
                  <input
                    class="quantity__input"
                    type="number"
                    data-quantity-variant-id="{{ item.variant.id }}"
                    name="updates[]"
                    value="{{ item.quantity }}"
                    {% # theme-check-disable %}
                    data-cart-quantity="{{ cart | item_count_for_variant: item.variant.id }}"
                    min="0"
                    data-min="{{ item.variant.quantity_rule.min }}"
                    {% if item.variant.quantity_rule.max != null %}
                      max="{{ item.variant.quantity_rule.max }}"
                    {% endif %}
                    step="{{ item.variant.quantity_rule.increment }}"
                    {% # theme-check-enable %}
                    aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
                    id="Quantity-{{ index }}"
                    data-index="{{ index }}"
                    {% if item.properties._role == 'return_shipping' %}
                      readonly
                    {% endif %}
                  >
                  {%- unless item.properties._role == 'return_shipping' -%}
                    <button class="quantity__button" name="plus" type="button">
                      <span class="visually-hidden">
                        {{- 'products.product.quantity.increase' | t: product: item.product.title | escape -}}
                      </span>
                      <span class="svg-wrapper"> + </span>
                    </button>
                  {%- endunless -%}
                </quantity-input>
              </div>
            </div>
            {%- if has_qty_rules or has_vol_pricing -%}
              <button
                type="button"
                class="quantity-popover__info-button quantity-popover__info-button--icon-with-label button button--tertiary"
                aria-expanded="false"
              >
                <span class="svg-wrapper">{{- 'icon-info.svg' | inline_asset_content -}}</span>
                <span>
                  {%- if has_vol_pricing -%}
                    {{ 'products.product.volume_pricing.note' | t }}
                  {%- elsif has_qty_rules -%}
                    {{ 'products.product.quantity.note' | t }}
                  {%- endif -%}
                </span>
              </button>
            {%- endif -%}
            {%- if has_vol_pricing or has_qty_rules -%}
              <div class="cart-items__info global-settings-popup quantity-popover__info" tabindex="-1" hidden>
                {%- if has_qty_rules == false -%}
                  <span class="volume-pricing-label caption">{{- 'products.product.volume_pricing.title' | t -}}</span>
                {%- endif -%}
                <div class="quantity__rules caption">
                  {%- if item.variant.quantity_rule.increment > 1 -%}
                    <span class="divider">
                      {{-
                        'products.product.quantity.multiples_of'
                        | t: quantity: item.variant.quantity_rule.increment
                      -}}
                    </span>
                  {%- endif -%}
                  {%- if item.variant.quantity_rule.min > 1 -%}
                    <span class="divider">
                      {{- 'products.product.quantity.min_of' | t: quantity: item.variant.quantity_rule.min -}}
                    </span>
                  {%- endif -%}
                  {%- if item.variant.quantity_rule.max != null -%}
                    <span class="divider">
                      {{- 'products.product.quantity.max_of' | t: quantity: item.variant.quantity_rule.max -}}
                    </span>
                  {%- endif -%}
                </div>
                <button
                  class="button-close button button--tertiary"
                  type="button"
                  aria-label="{{ 'accessibility.close' | t }}"
                >
                  <span class="svg-wrapper">{{- 'icon-close.svg' | inline_asset_content -}}</span>
                </button>
                {%- if item.variant.quantity_price_breaks.size > 0 -%}
                  <volume-pricing class="parent-display">
                    <ul class="list-unstyled">
                      <li>
                        <span>{{ item.variant.quantity_rule.min }}+</span>
                        <span>{{ item.variant.price | money_with_currency }}/ea</span>
                      </li>
                      {%- for price_break in item.variant.quantity_price_breaks -%}
                        <li>
                          <span>
                            {{- price_break.minimum_quantity -}}
                            <span aria-hidden="true">+</span></span
                          >
                          <span>{{ price_break.price | money_with_currency }}/ea</span>
                        </li>
                      {%- endfor -%}
                    </ul>
                  </volume-pricing>
                {%- endif -%}
              </div>
            {%- endif -%}
            <div id="CartDrawer-LineItemError-{{ index }}" class="cart-item__error" role="alert">
              <small class="cart-item__error-text"></small>
              <span class="svg-wrapper">{{- 'icon-error.svg' | inline_asset_content -}}</span>
            </div>
          </quantity-popover>
        </div>
      </div>
    </div>
  </div>
</div>
