<!-- Filter Trigger -->
<div class="filters-wrapper" id="active-filters">
  <div class="filter-trigger" data-hover-shake="small">
    <button
      id="open-filters"
      type="button"
      aria-haspopup="dialog"
      aria-controls="filters-modal"
      class="primary-button primary-button--small"
    >
      + Filters
    </button>
  </div>
</div>

<!-- Modal -->
<div
  id="filters-modal"
  class="filters-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="filters-modal-title"
  aria-hidden="true"
>
  <div class="filters-modal__dialog" role="document">
    {% comment %} <h3 class="filters-modal-title type-button-large">Filters</h3> {% endcomment %}

    {% comment %} Here there will be 3 buttons, All - New arrivals and Sale {% endcomment %}
    {% capture quick_links_html %}
      {% assign all_products_count = 0 %}
      {% if collections['all'] %}
        {% assign all_products_count = collections['all'].products_count | plus: 0 %}
      {% endif %}
      <a href="{{ routes.all_products_collection_url }}" class="primary-button primary-button--modal-filter">
        All{% if all_products_count > 0 %} <span>{{ all_products_count }}</span>{% endif %}
      </a>

      {% assign new_arrivals_count = 0 %}
      {% if collections['new-arrivals'] %}
        {% assign new_arrivals_count = collections['new-arrivals'].products_count | plus: 0 %}
        <a href="{{ collections['new-arrivals'].url }}" class="primary-button primary-button--modal-filter">
          New Arrivals{% if new_arrivals_count > 0 %} <span>{{ new_arrivals_count }}</span>{% endif %}
        </a>
      {% endif %}

      {% assign sale_count = 0 %}
      {% if collections['sale'] %}
        {% assign sale_count = collections['sale'].products_count | plus: 0 %}
        <a href="{{ collections['sale'].url }}" class="primary-button primary-button--modal-filter primary-button--red">
          Sale{% if sale_count > 0 %} <span>{{ sale_count }}</span>{% endif %}
        </a>
      {% endif %}
    {% endcapture %}
    {% render 'filter-link-group', title: 'Shop by', content_html: quick_links_html %}

    {% comment %} Here will be the list of collections which are buttons that immediately send the user to /collection/chosen-collection-name {% endcomment %}
    {% capture collections_links_html %}
      {% for coll in collections %}
        {%
          if coll.handle != 'events' and 
          coll.handle != 'all' and 
          coll.handle != 'new-arrivals' and 
          coll.handle != 'sale' and 
          coll.handle != 'frontpage'
        %}
          {% assign coll_count = coll.products_count | plus: 0 %}
          {% if coll_count > 0 %}
            <a data-attribute-name="{{ coll.handle }}" href="{{ coll.url }}" class="primary-button primary-button--modal-filter">
              {{ coll.title }} <span>{{ coll_count }}</span>
            </a>
          {% endif %}
        {% endif %}
      {% endfor %}
    {% endcapture %}
    {% render 'filter-link-group', title: 'Collections', content_html: collections_links_html %}

    {% comment %} Here will be tags for the current collection. If we are on the collection/film then there will be tags such as 35mm etc. {% endcomment %}

    <!-- TAGS -->
    {% assign all_tags = '' | split: '' %}
    {% for product in collection.products %}
      {% assign all_tags = all_tags | concat: product.tags %}
    {% endfor %}
    {% assign tag_list = all_tags | uniq %}
    {% render 'filter-group', title: 'Tags', items: tag_list, type: 'tag' %}

    {% comment %} Finally here will be brands or vendors for the current collection. {% endcomment %}
    <!-- VENDORS -->
    {% assign all_vendors = '' | split: '' %}
    {% for product in collection.products %}
      {% assign vendor_array = product.vendor | split: '|||' %}
      {% assign all_vendors = all_vendors | concat: vendor_array %}
    {% endfor %}
    {% assign vendor_list = all_vendors | uniq %}
    {% render 'filter-group', title: 'Brands', items: vendor_list, type: 'vendor' %}

    <div class="filters-modal__actions">
      <button id="apply-filters" type="button" class="primary-button primary-button--modal-filter rounded">
        Apply
      </button>
      <button
        id="clear-filters"
        type="button"
        class="primary-button primary-button--modal-filter primary-button--outline-white"
      >
        Clear
      </button>
      <button
        id="close-filters"
        type="button"
        class="primary-button primary-button--modal-filter primary-button--outline-white"
      >
        Close
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const openBtn = document.getElementById('open-filters');
    const closeBtn = document.getElementById('close-filters');
    const applyBtn = document.getElementById('apply-filters');
    const clearBtn = document.getElementById('clear-filters');
    const modal = document.getElementById('filters-modal');
    const filtersWrapper = document.getElementById('active-filters');
    const filterTrigger = filtersWrapper.querySelector('.filter-trigger');
    let filterOptions = document.querySelectorAll('.filter-option');

    let activeFilters = [];

    // Update filter options when modal opens (in case of dynamic content)
    function refreshFilterOptions() {
      filterOptions = document.querySelectorAll('.filter-option');
    }

    // Update active state styling
    function updateActiveStates() {
      filterOptions.forEach((opt) => {
        const label = opt.closest('label.filter-group__item');
        if (opt.checked) {
          label?.classList.add('is-active');
        } else {
          label?.classList.remove('is-active');
        }
      });
    }

    // Move modal to end of body to avoid stacking context issues
    if (modal && modal.parentNode !== document.body) {
      document.body.appendChild(modal);
    }

    // Modal toggle
    function openModal() {
      refreshFilterOptions();
      // Sync checkboxes with currently active filters
      filterOptions.forEach((opt) => {
        const isActive = activeFilters.some((f) => f.type === opt.dataset.filterType && f.value === opt.value);
        opt.checked = isActive;
      });
      updateActiveStates();
      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
      document.body.classList.add('is-modal-open');
    }

    function closeModal() {
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('is-modal-open');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    // Update active state when checkboxes change
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('filter-option')) {
        updateActiveStates();
      }
    });

    // Clear all filters
    clearBtn.addEventListener('click', () => {
      activeFilters = [];
      filterOptions.forEach((opt) => {
        opt.checked = false;
      });
      updateActiveStates();
      renderActiveFilters();
      filterProducts();
    });

    // Apply filters
    applyBtn.addEventListener('click', () => {
      activeFilters = [];
      filterOptions.forEach((opt) => {
        if (opt.checked) {
          activeFilters.push({ type: opt.dataset.filterType, value: opt.value });
        }
      });
      renderActiveFilters();
      closeModal();
      filterProducts();
    });

    // Render filter chips
    function renderActiveFilters() {
      // Remove existing active filter buttons (but keep filter-trigger)
      const existingFilters = filtersWrapper.querySelectorAll('.primary-button--active-filter');
      existingFilters.forEach((el) => el.remove());

      // Add active filter buttons
      activeFilters.forEach((f) => {
        const filterButton = document.createElement('button');
        filterButton.type = 'button';
        filterButton.className = 'primary-button primary-button--small primary-button--active-filter';
        filterButton.innerHTML = '<span class="active-filter-remove">Ã—</span> ' + f.value;
        filterButton.setAttribute('aria-label', 'Remove filter ' + f.value);
        filterButton.addEventListener('click', () => {
          activeFilters = activeFilters.filter((x) => !(x.type === f.type && x.value === f.value));
          filterOptions.forEach((opt) => {
            if (opt.dataset.filterType === f.type && opt.value === f.value) {
              opt.checked = false;
            }
          });
          updateActiveStates();
          renderActiveFilters();
          filterProducts();
        });
        // Insert after filter-trigger
        filterTrigger.insertAdjacentElement('afterend', filterButton);
      });
    }

    // Dynamic filtering
    function filterProducts() {
      const products = document.querySelectorAll(
        '.product-card[data-product-tags], .product-card[data-product-vendor]'
      );

      const filterHandlers = {
        tag: (prod, value) => {
          const tags = (prod.dataset.productTags || '').split(',').map((s) => s.trim());
          return tags.includes(value);
        },
        vendor: (prod, value) => {
          const vendor = prod.dataset.productVendor || '';
          // Handle vendor string that might have ||| separator
          const vendorParts = vendor.split('|||').map((s) => s.trim());
          return vendorParts.includes(value) || vendor === value;
        },
        collection: (prod, value) =>
          (prod.dataset.productCollections || '')
            .split(',')
            .map((s) => s.trim())
            .includes(value),

        // Extendable:
        // price: (prod, value) => parseFloat(prod.dataset.productPrice) <= parseFloat(value),
        // color: (prod, value) => (prod.dataset.productColors || '').split(',').includes(value),
      };

      products.forEach((prod) => {
        if (activeFilters.length === 0) {
          prod.style.display = '';
          return;
        }

        // Group filters by type
        const filtersByType = {};
        activeFilters.forEach((f) => {
          if (!filtersByType[f.type]) {
            filtersByType[f.type] = [];
          }
          filtersByType[f.type].push(f.value);
        });

        // Product must match ALL filter types (AND logic)
        // But can match ANY value within each type (OR logic)
        let matchesAll = true;
        for (const [type, values] of Object.entries(filtersByType)) {
          const matchesThisType = values.some((val) => filterHandlers[type]?.(prod, val));
          if (!matchesThisType) {
            matchesAll = false;
            break;
          }
        }

        prod.style.display = matchesAll ? '' : 'none';
      });
    }
  });
</script>
